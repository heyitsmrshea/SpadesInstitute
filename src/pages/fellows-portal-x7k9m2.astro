---
import Layout from '../components/Layout.astro';
import fellows from '../data/fellows.json';

const base = import.meta.env.BASE_URL.replace(/\/$/, '');

// Group fellows by cohort
const cohorts = [...new Set(fellows.map(f => f.cohort))].sort().reverse();
const fellowsByCohort = cohorts.map(cohort => ({
  cohort,
  fellows: fellows.filter(f => f.cohort === cohort)
}));

// Stats
const totalFellows = fellows.length;
const nsFellows = fellows.filter(f => f.role.includes('National Security')).length;
const vetFellows = fellows.filter(f => f.role.includes('Veterans')).length;
---
<Layout 
  title="Fellows Directory | Spades Institute" 
  description="Private directory for Spades Institute fellows."
>
  <!-- Note: This page is unlisted. Do not add to navigation. -->
  
  <!-- Header -->
  <section class="bg-spades-ink-deep section-padding-sm">
    <div class="max-w-5xl mx-auto px-6 text-center">
      <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/10 border border-white/20 text-sm text-white/80 mb-6">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
        <span>Private Directory</span>
      </div>
      <h1 class="text-heading-xl md:text-heading-2xl text-white">Fellows Directory</h1>
      <p class="mt-4 text-lg text-dark-secondary max-w-2xl mx-auto">
        Connect with fellow program participants. This page is not publicly listed.
      </p>
      
      <!-- Stats -->
      <div class="mt-8 flex flex-wrap justify-center gap-6">
        <div class="text-center">
          <p class="text-3xl font-semibold text-white">{totalFellows}</p>
          <p class="text-sm text-white/60">Total Fellows</p>
        </div>
        <div class="text-center">
          <p class="text-3xl font-semibold text-white">{nsFellows}</p>
          <p class="text-sm text-white/60">NS Fellows</p>
        </div>
        <div class="text-center">
          <p class="text-3xl font-semibold text-white">{vetFellows}</p>
          <p class="text-sm text-white/60">Veterans Fellows</p>
        </div>
        <div class="text-center">
          <p class="text-3xl font-semibold text-white">{cohorts.length}</p>
          <p class="text-sm text-white/60">Cohorts</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Search/Filter -->
  <section class="bg-white border-b border-spades-border sticky top-14 z-30">
    <div class="max-w-5xl mx-auto px-6 py-4">
      <div class="flex flex-wrap items-center gap-4">
        <div class="flex-1 min-w-[200px]">
          <input 
            type="search" 
            id="fellow-search"
            placeholder="Search by name, organization, or bio..."
            class="w-full px-4 py-2 rounded-lg border border-spades-border bg-spades-paper text-spades-text placeholder-spades-muted focus:outline-none focus:ring-2 focus:ring-spades-accent focus:border-transparent"
          />
        </div>
        <div class="flex gap-2">
          <button type="button" data-filter="all" class="filter-btn active px-3 py-2 rounded-lg text-sm font-medium transition-colors">
            All
          </button>
          <button type="button" data-filter="National Security" class="filter-btn px-3 py-2 rounded-lg text-sm font-medium transition-colors">
            NS Fellows
          </button>
          <button type="button" data-filter="Veterans" class="filter-btn px-3 py-2 rounded-lg text-sm font-medium transition-colors">
            Veterans
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Fellows List -->
  <section class="bg-spades-paper section-padding">
    <div class="max-w-5xl mx-auto px-6">
      {fellowsByCohort.map(({ cohort, fellows: cohortFellows }) => (
        <div class="mb-12 last:mb-0" data-cohort={cohort}>
          <div class="flex items-center gap-4 mb-6">
            <h2 class="text-heading-md text-spades-text whitespace-nowrap">{cohort}</h2>
            <div class="flex-1 h-px bg-spades-border"></div>
            <span class="text-sm text-spades-muted">{cohortFellows.length} fellows</span>
          </div>
          
          <div class="grid md:grid-cols-2 gap-4">
            {cohortFellows.map((fellow) => (
              <article 
                class="fellow-card card p-5 flex gap-4"
                data-name={fellow.name.toLowerCase()}
                data-org={fellow.organization.toLowerCase()}
                data-bio={fellow.bio.toLowerCase()}
                data-role={fellow.role}
              >
                <div class="flex-shrink-0">
                  <div class="w-16 h-16 rounded-xl bg-spades-accent/10 flex items-center justify-center text-spades-accent text-xl font-semibold">
                    {fellow.name.split(' ').map(n => n[0]).join('')}
                  </div>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex items-start justify-between gap-2">
                    <div>
                      <h3 class="font-semibold text-spades-text">{fellow.name}</h3>
                      <p class="text-sm text-spades-accent">{fellow.role}</p>
                    </div>
                    {fellow.linkedin && (
                      <a 
                        href={fellow.linkedin} 
                        target="_blank" 
                        rel="noreferrer"
                        class="text-spades-muted hover:text-spades-accent transition-colors"
                        aria-label={`${fellow.name} on LinkedIn`}
                      >
                        <svg viewBox="0 0 24 24" class="w-5 h-5 fill-current">
                          <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.35V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.6 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.063 2.063 0 114.126 0 2.062 2.062 0 01-2.063 2.065zM6.114 20.452H4.56V9h3.554v11.452H6.114zM22.225 0H1.771C.792 0 0 .774 0 1.727v20.545C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.273V1.727C24 .774 23.2 0 22.222 0h.003z" />
                        </svg>
                      </a>
                    )}
                  </div>
                  <p class="text-xs text-spades-muted mt-1">
                    {fellow.organization} â†’ {fellow.placement}
                  </p>
                  <p class="text-sm text-spades-text-secondary mt-2 line-clamp-2">{fellow.bio}</p>
                </div>
              </article>
            ))}
          </div>
        </div>
      ))}
      
      <!-- Empty state -->
      <div id="no-results" class="hidden text-center py-12">
        <p class="text-spades-text-secondary">No fellows match your search.</p>
      </div>
    </div>
  </section>

  <!-- Footer note -->
  <section class="bg-white border-t border-spades-border py-8">
    <div class="max-w-3xl mx-auto px-6 text-center">
      <p class="text-sm text-spades-muted">
        This directory is for Spades Institute fellows only. Please do not share this link publicly.
        <br />
        Need to update your profile? <a href={`${base}/connect`} class="text-spades-accent hover:underline">Contact us</a>.
      </p>
    </div>
  </section>
</Layout>

<style>
  .filter-btn {
    background-color: transparent;
    color: var(--color-muted, #4b5563);
    border: 1px solid var(--color-border, #e5e7eb);
  }
  
  .filter-btn:hover {
    background-color: var(--color-paper, #fbfbf7);
    border-color: var(--color-accent, #1e3a5f);
    color: var(--color-accent, #1e3a5f);
  }
  
  .filter-btn.active {
    background-color: var(--color-accent, #1e3a5f);
    border-color: var(--color-accent, #1e3a5f);
    color: white;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  const searchInput = document.getElementById('fellow-search') as HTMLInputElement;
  const filterBtns = document.querySelectorAll('.filter-btn');
  const fellowCards = document.querySelectorAll('.fellow-card');
  const cohortSections = document.querySelectorAll('[data-cohort]');
  const noResults = document.getElementById('no-results');
  
  let currentFilter = 'all';
  let currentSearch = '';
  
  function filterFellows() {
    let visibleCount = 0;
    
    fellowCards.forEach(card => {
      const name = card.getAttribute('data-name') || '';
      const org = card.getAttribute('data-org') || '';
      const bio = card.getAttribute('data-bio') || '';
      const role = card.getAttribute('data-role') || '';
      
      const matchesSearch = currentSearch === '' || 
        name.includes(currentSearch) || 
        org.includes(currentSearch) || 
        bio.includes(currentSearch);
      
      const matchesFilter = currentFilter === 'all' || role.includes(currentFilter);
      
      if (matchesSearch && matchesFilter) {
        (card as HTMLElement).classList.remove('hidden');
        visibleCount++;
      } else {
        (card as HTMLElement).classList.add('hidden');
      }
    });
    
    // Hide empty cohort sections
    cohortSections.forEach(section => {
      const visibleCards = section.querySelectorAll('.fellow-card:not(.hidden)');
      if (visibleCards.length === 0) {
        (section as HTMLElement).classList.add('hidden');
      } else {
        (section as HTMLElement).classList.remove('hidden');
      }
    });
    
    // Show/hide no results message
    if (noResults) {
      if (visibleCount === 0) {
        noResults.classList.remove('hidden');
      } else {
        noResults.classList.add('hidden');
      }
    }
  }
  
  // Search handler
  searchInput?.addEventListener('input', (e) => {
    currentSearch = (e.target as HTMLInputElement).value.toLowerCase();
    filterFellows();
  });
  
  // Filter button handlers
  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      filterBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.getAttribute('data-filter') || 'all';
      filterFellows();
    });
  });
</script>

