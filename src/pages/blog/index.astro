---
import { getCollection } from 'astro:content';
import Layout from '../../components/Layout.astro';
import BlogCard from '../../components/BlogCard.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import people from '../../data/people.json';

const baseRaw = import.meta.env.BASE_URL || '/';
const base = baseRaw.endsWith('/') ? baseRaw.slice(0, -1) : baseRaw;
const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://www.spadesinstitute.org';

// Get all non-draft blog posts, sorted by date (newest first)
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const sortedPosts = allPosts.sort((a, b) => 
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// Featured post is the newest
const featuredPost = sortedPosts[0];
const remainingPosts = sortedPosts.slice(1);

// Determine layout mode based on post count
const isLowVolume = sortedPosts.length <= 3;

// Page metadata
const title = "Briefings | Spades Institute";
const description = "Insights and perspectives on national security, ethics, and cross-sector collaboration from the Spades Institute team.";
---

<Layout {title} {description}>
  <head slot="head">
    <meta name="description" content={description} />
    <link rel="canonical" href={`${siteUrl}${base}/blog`} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={`${siteUrl}${base}/blog`} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
  </head>

  <!-- Breadcrumbs removed for cleaner look -->

  <!-- Hero Section -->
  <section class="bg-spades-ink-deep section-padding-sm">
    <div class="max-w-4xl mx-auto px-6 text-center motion-safe:animate-fadeUp">
      <p class="text-xs uppercase tracking-widest text-spades-muted-light mb-4">Insights & Perspectives</p>
      <h1 class="text-heading-xl md:text-heading-2xl text-white not-italic">Briefings</h1>
      <p class="mt-4 text-lg text-dark-secondary max-w-2xl mx-auto leading-relaxed">
        Actionable writing on national security, ethics, and cross-sector execution.
      </p>
    </div>
  </section>

  <!-- Featured Post -->
  {featuredPost && (
    <section class="bg-spades-paper section-padding-sm border-b border-spades-border">
      <div class="max-w-5xl mx-auto px-6">
        <p class="text-xs uppercase tracking-widest text-spades-muted mb-4">Featured Briefing</p>
        <BlogCard post={featuredPost} featured={true} />
      </div>
    </section>
  )}

  <!-- Posts Grid/List -->
  <section class="bg-white section-padding">
    <div class="max-w-5xl mx-auto px-6">
      {remainingPosts.length > 0 ? (
        <>
          <h2 class="text-heading-md text-spades-text mb-6">More Briefings</h2>
          
          {isLowVolume ? (
            <!-- Compact list layout for low volume -->
            <div id="posts-container" class="space-y-4">
              {remainingPosts.map((post, i) => {
                const formattedDate = new Date(post.data.date).toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric'
                });
                const author = people.find(p => p.name === post.data.author);
                return (
                  <a 
                    href={`${base}/blog/${post.slug}`}
                    class="post-item group card p-4 flex flex-col sm:flex-row sm:items-center gap-4 motion-safe:animate-fadeIn"
                    style={`animation-delay: ${i * 50}ms`}
                  >
                    <div class="flex-1 min-w-0">
                      <h3 class="font-semibold text-spades-text group-hover:text-spades-accent transition-colors truncate">
                        {post.data.title}
                      </h3>
                      <p class="text-sm text-spades-text-secondary mt-1 clamp-2">{post.data.excerpt}</p>
                    </div>
                    <div class="flex items-center gap-3 text-sm text-spades-muted flex-shrink-0">
                      {author?.headshot && (
                        <img
                          src={`${base}${author.headshot.startsWith('/') ? author.headshot : '/' + author.headshot}`}
                          alt={`${post.data.author} headshot`}
                          class="w-8 h-8 rounded-full object-cover border border-spades-border"
                          width="32"
                          height="32"
                          loading="lazy"
                          decoding="async"
                        />
                      )}
                      <div class="flex items-center gap-4">
                        <span>{post.data.author}</span>
                        <time datetime={post.data.date.toISOString()}>{formattedDate}</time>
                      </div>
                    </div>
                  </a>
                );
              })}
            </div>
          ) : (
            <!-- Grid layout for higher volume -->
            <div id="posts-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
              {remainingPosts.map((post, i) => (
                <div 
                  data-tags={JSON.stringify(post.data.tags)}
                  class="post-item motion-safe:animate-fadeIn" 
                  style={`animation-delay: ${i * 50}ms`}
                >
                  <BlogCard post={post} />
                </div>
              ))}
            </div>
          )}
          
        </>
      ) : (
        <div class="text-center py-12">
          <p class="text-spades-text-secondary">More articles coming soon.</p>
        </div>
      )}
    </div>
  </section>

  <!-- Subscribe CTA -->
  <section class="bg-spades-paper section-padding border-t border-spades-border">
    <div class="max-w-2xl mx-auto px-6 text-center">
      <h2 class="text-heading-lg text-spades-text mb-4">Stay Informed</h2>
      <p class="text-spades-text-secondary mb-6">
        Subscribe to receive new articles and updates from Spades Institute.
      </p>
      
      <form id="subscribe-form" class="max-w-md mx-auto">
        <div class="flex flex-col sm:flex-row gap-3">
          <div class="flex-1">
            <label for="subscribe-email" class="sr-only">Email address</label>
            <input 
              id="subscribe-email"
              type="email" 
              name="email"
              placeholder="your@email.com" 
              class="w-full px-4 py-3 rounded-lg border border-spades-border bg-white text-spades-text placeholder-spades-muted focus:outline-none focus:ring-2 focus:ring-spades-accent focus:border-transparent transition-shadow"
              required
              aria-describedby="email-error"
            />
            <p id="email-error" class="hidden mt-2 text-sm text-red-600" role="alert"></p>
          </div>
          <button 
            type="submit" 
            id="subscribe-btn"
            class="btn btn-primary whitespace-nowrap"
          >
            <span id="btn-text">Subscribe</span>
            <svg id="btn-spinner" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
        </div>
        
        <!-- Success message -->
        <div id="success-message" class="hidden mt-4 p-4 rounded-lg bg-green-50 border border-green-200">
          <p class="text-sm text-green-800">
            âœ“ Thank you for subscribing! Check your email to confirm.
          </p>
        </div>
      </form>
      
      <p class="mt-4 text-xs text-spades-muted">
        We respect your privacy. Unsubscribe at any time.
      </p>
    </div>
  </section>
</Layout>

<script>
  // Subscribe form validation
  const form = document.getElementById('subscribe-form') as HTMLFormElement;
  const emailInput = document.getElementById('subscribe-email') as HTMLInputElement;
  const emailError = document.getElementById('email-error');
  const submitBtn = document.getElementById('subscribe-btn');
  const btnText = document.getElementById('btn-text');
  const btnSpinner = document.getElementById('btn-spinner');
  const successMessage = document.getElementById('success-message');
  
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Clear previous errors
      if (emailError) {
        emailError.classList.add('hidden');
        emailError.textContent = '';
      }
      
      // Validate email
      const email = emailInput?.value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      
      if (!email || !emailRegex.test(email)) {
        if (emailError) {
          emailError.textContent = 'Please enter a valid email address.';
          emailError.classList.remove('hidden');
        }
        emailInput?.focus();
        return;
      }
      
      // Show loading state
      if (submitBtn) submitBtn.setAttribute('disabled', 'true');
      if (btnText) btnText.textContent = 'Subscribing...';
      if (btnSpinner) btnSpinner.classList.remove('hidden');
      
      // Simulate submission (in production, this would be an API call)
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Show success
      if (successMessage) successMessage.classList.remove('hidden');
      if (emailInput) emailInput.value = '';
      
      // Reset button
      if (submitBtn) submitBtn.removeAttribute('disabled');
      if (btnText) btnText.textContent = 'Subscribe';
      if (btnSpinner) btnSpinner.classList.add('hidden');
      
      // Open mailto as fallback
      const subject = encodeURIComponent('Newsletter Subscription');
      const body = encodeURIComponent(`Please add ${email} to the Spades Institute newsletter.`);
      window.location.href = `mailto:info@spadesinstitute.org?subject=${subject}&body=${body}`;
    });
  }
</script>