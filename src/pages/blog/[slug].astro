---
import { getCollection } from 'astro:content';
import Layout from '../../components/Layout.astro';
import BlogPost from '../../components/BlogPost.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

// Calculate reading time
const wordCount = post.body?.split(/\s+/).length || 0;
const readingTime = Math.ceil(wordCount / 200);

// Page metadata
const title = `${post.data.title} | Spades Institute Blog`;
const description = post.data.excerpt;
const publishedDate = new Date(post.data.date).toISOString();
const featuredImage = post.data.featuredImage 
  ? `https://www.spadesinstitute.org${base}${post.data.featuredImage.replace(/^\//, '')}`
  : null;

// JSON-LD structured data
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": post.data.title,
  "description": post.data.excerpt,
  "author": {
    "@type": "Person",
    "name": post.data.author
  },
  "datePublished": publishedDate,
  "publisher": {
    "@type": "Organization",
    "name": "Spades Institute",
    "url": "https://www.spadesinstitute.org"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://www.spadesinstitute.org${base}/blog/${post.slug}`
  },
  ...(featuredImage && { "image": featuredImage })
};
---

<Layout title={title} description={description}>
  <head slot="head">
    <meta name="description" content={description} />
    <!-- Open Graph -->
    <meta property="og:title" content={post.data.title} />
    <meta property="og:description" content={post.data.excerpt} />
    <meta property="og:type" content="article" />
    <meta property="og:url" content={`https://www.spadesinstitute.org${base}/blog/${post.slug}`} />
    {featuredImage && <meta property="og:image" content={featuredImage} />}
    <meta property="article:published_time" content={publishedDate} />
    <meta property="article:author" content={post.data.author} />
    {post.data.tags.map(tag => (
      <meta property="article:tag" content={tag} />
    ))}

    <!-- Twitter Card -->
    <meta name="twitter:card" content={featuredImage ? "summary_large_image" : "summary"} />
    <meta name="twitter:title" content={post.data.title} />
    <meta name="twitter:description" content={post.data.excerpt} />
    {featuredImage && <meta name="twitter:image" content={featuredImage} />}

    <!-- JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />

    <!-- Canonical URL -->
    <link rel="canonical" href={`https://www.spadesinstitute.org${base}/blog/${post.slug}`} />
  </head>

  <BlogPost post={post}>
    <Content />
  </BlogPost>
</Layout>

