---
import Layout from '../components/Layout.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://www.spadesinstitute.org';
---
<Layout 
  title="Spades Institute | Connect" 
  description="Partner with Spades Institute. Share a challenge, idea, or partnership opportunity. We'll respond within one week."
>
  <head slot="head">
    <link rel="canonical" href={`${siteUrl}${base}/connect`} />
  </head>

  <!-- Breadcrumbs removed for cleaner look -->

  <!-- Hero -->
  <section class="bg-spades-ink-deep section-padding-sm relative overflow-hidden">
    <div class="absolute inset-0 bg-hex-pattern opacity-30" aria-hidden="true"></div>
    
    <div class="max-w-4xl mx-auto px-6 text-center relative blur-reveal">
      <p class="text-xs uppercase tracking-widest text-spades-muted-light mb-4">Connect</p>
      <h1 class="text-heading-xl md:text-heading-2xl text-white">Partner with Spades</h1>
      <p class="mt-4 text-lg text-dark-secondary max-w-2xl mx-auto leading-relaxed">
        Share a challenge, an idea, or a partnership opportunity. We'll respond within the week.
      </p>
    </div>
  </section>

  <!-- Contact Form -->
  <section class="bg-spades-paper section-padding">
    <div class="max-w-5xl mx-auto px-6 grid gap-8 lg:grid-cols-5 items-start">
      <!-- Form -->
      <div class="lg:col-span-3">
        <div class="card p-5 md:p-8">
          <h2 class="text-2xl md:text-heading-md text-spades-text mb-2">Send a note</h2>
          <p class="text-sm md:text-base text-spades-text-secondary mb-6 md:mb-8">
            Fill out the form below and we'll get back to you within one week.
          </p>

          <!-- Success Message -->
          <div id="form-success" class="hidden mb-6 p-4 rounded-lg bg-green-50 border border-green-200">
            <p class="text-green-800 font-semibold">Message sent successfully!</p>
            <p class="text-green-600 text-sm mt-1">We'll get back to you within one week.</p>
          </div>

          <!-- Error Message -->
          <div id="form-error" class="hidden mb-6 p-4 rounded-lg bg-red-50 border border-red-200">
            <p class="text-red-800 font-semibold" id="error-message">Failed to send message.</p>
          </div>

          <form id="contactForm" class="space-y-5">
            <label for="contact-name" class="block">
              <span class="text-sm font-medium text-spades-text mb-2 block">Name</span>
              <input 
                id="contact-name"
                name="name" 
                required 
                class="w-full rounded-lg border border-spades-border px-4 py-3 bg-white text-spades-text focus:outline-none focus:ring-2 focus:ring-spades-accent focus:border-transparent transition-shadow" 
              />
            </label>
            <label for="contact-email" class="block">
              <span class="text-sm font-medium text-spades-text mb-2 block">Email</span>
              <input 
                id="contact-email"
                name="email" 
                type="email" 
                required 
                class="w-full rounded-lg border border-spades-border px-4 py-3 bg-white text-spades-text focus:outline-none focus:ring-2 focus:ring-spades-accent focus:border-transparent transition-shadow" 
              />
            </label>
            <label for="contact-org" class="block">
              <span class="text-sm font-medium text-spades-text mb-2 block">Organization <span class="text-spades-muted font-normal">(optional)</span></span>
              <input 
                id="contact-org"
                name="org" 
                class="w-full rounded-lg border border-spades-border px-4 py-3 bg-white text-spades-text focus:outline-none focus:ring-2 focus:ring-spades-accent focus:border-transparent transition-shadow" 
              />
            </label>
            <label for="contact-topic" class="block">
              <span class="text-sm font-medium text-spades-text mb-2 block">Topic</span>
              <select 
                id="contact-topic"
                name="topic" 
                required
                class="w-full rounded-lg border border-spades-border px-4 py-3 bg-white text-spades-text focus:outline-none focus:ring-2 focus:ring-spades-accent focus:border-transparent transition-shadow"
              >
                <option value="" disabled selected>Select below</option>
                <option>Speaker Series</option>
                <option>National Security Fellowship</option>
                <option>Veteran Mentoring</option>
                <option>Partnership / Sponsorship</option>
                <option>Other</option>
              </select>
            </label>
            <label for="message-textarea" class="block">
              <span class="text-sm font-medium text-spades-text mb-2 block">
                Message
                <span id="char-count" class="text-spades-muted font-normal ml-2">(0 characters)</span>
              </span>
              <textarea 
                name="message" 
                id="message-textarea"
                rows="5" 
                required 
                maxlength="2000"
                class="w-full rounded-lg border border-spades-border px-4 py-3 bg-white text-spades-text focus:outline-none focus:ring-2 focus:ring-spades-accent focus:border-transparent transition-shadow resize-y"
                aria-describedby="char-count message-error"
              ></textarea>
              <p id="message-error" class="hidden mt-2 text-sm text-red-600" role="alert"></p>
            </label>

            <div class="pt-2 flex flex-wrap items-center gap-4">
              <button type="submit" id="submit-btn" class="btn btn-primary">
                <span id="submit-text">Send message</span>
                <span id="submit-spinner" class="hidden ml-2">
                  <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </span>
              </button>
              <a class="btn btn-tertiary" href="mailto:info@spadesinstitute.org">
                Or email directly
              </a>
            </div>
            <p class="text-sm text-spades-muted">
              We typically respond within one week.
            </p>
          </form>
        </div>
      </div>

      <!-- Sidebar -->
      <aside class="lg:col-span-2 space-y-4">
        <div class="card p-6">
          <p class="text-sm font-medium text-spades-muted mb-2">Email</p>
          <a href="mailto:info@spadesinstitute.org" class="text-lg font-semibold text-spades-accent hover:text-spades-accent-hover transition-colors">
            info@spadesinstitute.org
          </a>
        </div>
        <div class="card p-6">
          <p class="text-sm font-medium text-spades-muted mb-2">LinkedIn</p>
          <a 
            href="https://www.linkedin.com/company/spades-institute" 
            target="_blank" 
            rel="noreferrer" 
            class="text-sm font-medium text-spades-accent hover:text-spades-accent-hover transition-colors inline-flex items-center gap-1"
            aria-label="Follow Spades Institute on LinkedIn"
          >
            Follow updates <span aria-hidden="true">→</span>
          </a>
        </div>
        <div class="card p-6">
          <p class="text-sm font-medium text-spades-muted mb-2">Location</p>
          <p class="text-spades-text-secondary">San Diego to Washington DC</p>
        </div>
      </aside>
    </div>
  </section>

  <!-- Government Employees Section - Link to Ethics Letter Page -->
  <section class="bg-spades-ink-deep section-padding-sm">
    <div class="max-w-4xl mx-auto px-6">
      <div class="card card-dark p-8 md:p-10 text-center">
        <p class="text-xs uppercase tracking-widest text-spades-muted-light mb-3">For Government Employees</p>
        <h2 class="text-heading-lg text-white mb-4">Need an Ethics Letter?</h2>
        <p class="text-dark-secondary max-w-xl mx-auto mb-6">
          Generate a pre-filled ethics disclosure form to submit with your volunteer or engagement request.
        </p>
        <a href={`${base}/ethics-letter/`} class="btn btn-invert">
          Go to Ethics Letter Generator
          <span aria-hidden="true">→</span>
        </a>
      </div>
    </div>
  </section>

  <!-- FAQ Section -->
  <section class="bg-white section-padding border-t border-spades-border">
    <div class="max-w-3xl mx-auto px-6">
      <div class="text-center mb-10">
        <h2 class="text-heading-lg text-spades-text">Frequently Asked Questions</h2>
      </div>
      <div class="space-y-4">
        {[
          {
            q: "What happens after I submit?",
            a: "Your email client will open with your message pre-filled. Send the email, and we'll receive it at info@spadesinstitute.org. We typically respond within one week."
          },
          {
            q: "What types of partnerships do you consider?",
            a: "We work with government agencies, industry leaders, academic institutions, and nonprofits. We're particularly interested in partnerships that advance ethics, democracy, and freedom through trusted collaboration."
          },
          {
            q: "How quickly will I receive a response?",
            a: "We aim to respond to all inquiries within one week. For urgent matters, please note that in your message subject line."
          }
        ].map((faq) => (
          <details class="group card p-0 overflow-hidden">
            <summary class="cursor-pointer p-6 flex items-center justify-between gap-4 focus-accent">
              <span class="font-semibold text-spades-text">{faq.q}</span>
              <svg class="w-5 h-5 text-spades-muted flex-shrink-0 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </summary>
            <div class="px-6 pb-6 pt-0">
              <p class="text-body text-spades-text-secondary">{faq.a}</p>
            </div>
          </details>
        ))}
      </div>
    </div>
  </section>

  <script>
    const form = document.getElementById('contactForm');
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const submitSpinner = document.getElementById('submit-spinner');
    const formSuccess = document.getElementById('form-success');
    const formError = document.getElementById('form-error');
    const errorMessage = document.getElementById('error-message');
    const messageTextarea = document.getElementById('message-textarea');
    const charCount = document.getElementById('char-count');
    const messageError = document.getElementById('message-error');
    
    // Character count for textarea
    if (messageTextarea && charCount) {
      messageTextarea.addEventListener('input', () => {
        const length = messageTextarea.value.length;
        charCount.textContent = `(${length} / 2000 characters)`;
        if (length > 1800) {
          charCount.classList.add('text-orange-600');
          charCount.classList.remove('text-spades-muted');
        } else {
          charCount.classList.remove('text-orange-600');
          charCount.classList.add('text-spades-muted');
        }
      });
    }
    
    // Real-time validation
    const inputs = form?.querySelectorAll('input, textarea, select');
    inputs?.forEach((input) => {
      input.addEventListener('blur', () => {
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
          if (input.hasAttribute('required') && !input.value.trim()) {
            input.classList.add('border-red-300');
            input.classList.remove('border-spades-border');
          } else {
            input.classList.remove('border-red-300');
            input.classList.add('border-spades-border');
          }
        }
      });
      
      input.addEventListener('input', () => {
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
          if (input.value.trim()) {
            input.classList.remove('border-red-300');
            input.classList.add('border-spades-border');
          }
        }
      });
    });

    if (form) {
      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        
        // Hide previous messages
        if (formSuccess) formSuccess.classList.add('hidden');
        if (formError) formError.classList.add('hidden');

        // Get form data
        const data = new FormData(form);
        const payload = {
          name: String(data.get('name') || ''),
          email: String(data.get('email') || ''),
          org: String(data.get('org') || ''),
          topic: String(data.get('topic') || ''),
          message: String(data.get('message') || ''),
        };

        // Validate
        if (!payload.name || !payload.email || !payload.topic || !payload.message) {
          if (formError && errorMessage) {
            errorMessage.textContent = 'Please fill in all required fields.';
            formError.classList.remove('hidden');
          }
          // Highlight invalid fields
          if (!payload.name) form.querySelector('[name="name"]')?.classList.add('border-red-300');
          if (!payload.email) form.querySelector('[name="email"]')?.classList.add('border-red-300');
          if (!payload.topic) form.querySelector('[name="topic"]')?.classList.add('border-red-300');
          if (!payload.message) {
            messageTextarea?.classList.add('border-red-300');
            if (messageError) {
              messageError.textContent = 'Message is required.';
              messageError.classList.remove('hidden');
            }
          }
          return;
        }
        
        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(payload.email)) {
          if (formError && errorMessage) {
            errorMessage.textContent = 'Please enter a valid email address.';
            formError.classList.remove('hidden');
          }
          form.querySelector('[name="email"]')?.classList.add('border-red-300');
          return;
        }
        
        // Validate message length
        if (payload.message.length < 10) {
          if (messageError) {
            messageError.textContent = 'Message must be at least 10 characters.';
            messageError.classList.remove('hidden');
          }
          messageTextarea?.classList.add('border-red-300');
          return;
        }

        // Show loading state
        if (submitBtn) submitBtn.disabled = true;
        if (submitText) submitText.textContent = 'Sending...';
        if (submitSpinner) submitSpinner.classList.remove('hidden');

        try {
          // Format message for Web3Forms
          const formattedMessage = `
Name: ${payload.name}
Email: ${payload.email}
Organization: ${payload.org || 'Not provided'}
Topic: ${payload.topic}

Message:
${payload.message}
          `.trim();

          const response = await fetch('https://api.web3forms.com/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              access_key: 'af55db57-d883-47ff-940d-ba828e1ccb3e',
              subject: `Spades Institute Contact Form - ${payload.topic}`,
              from_name: payload.name,
              email: payload.email,
              replyto: payload.email,
              message: formattedMessage,
            }),
          });

          const result = await response.json();

          if (response.ok && result.success) {
            // Show success
            if (formSuccess) formSuccess.classList.remove('hidden');
            form.reset();

            // Reset character count
            if (charCount) charCount.textContent = '(0 characters)';
            if (charCount) {
              charCount.classList.remove('text-orange-600');
              charCount.classList.add('text-spades-muted');
            }

            // Scroll to success message
            formSuccess?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          } else {
            // Show error
            if (formError && errorMessage) {
              errorMessage.textContent = result.message || 'Failed to send message. Please try again or email us directly.';
              formError.classList.remove('hidden');
            }
          }
        } catch (error) {
          // Show error
          if (formError && errorMessage) {
            errorMessage.textContent = 'Network error. Please check your connection and try again, or email us directly at info@spadesinstitute.org';
            formError.classList.remove('hidden');
          }
        } finally {
          // Reset button
          if (submitBtn) submitBtn.disabled = false;
          if (submitText) submitText.textContent = 'Send message';
          if (submitSpinner) submitSpinner.classList.add('hidden');
        }
      });
    }
  </script>
</Layout>
