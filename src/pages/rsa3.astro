---
import Layout from '../components/Layout.astro';
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://www.spadesinstitute.org';

const events = [
  {
    id: 'dinner',
    name: 'Mission Brief: Dinner',
    tagline: 'An evening of trusted conversation',
    date: 'Monday, April 28, 2025',
    time: '6:30 PM - 9:30 PM PT',
    location: 'San Francisco, CA',
    locationDetail: 'Venue details shared upon confirmation',
    description: 'Join fellow operators, innovators, and government leaders for an intimate dinner conversation on the intersection of cybersecurity and national security.',
    calendarStart: '20250428T183000',
    calendarEnd: '20250428T213000',
  },
  {
    id: 'breakfast',
    name: 'Mission Brief: Breakfast',
    tagline: 'Start the day with purpose',
    date: 'Tuesday, April 29, 2025',
    time: '7:30 AM - 9:00 AM PT',
    location: 'San Francisco, CA',
    locationDetail: 'Venue details shared upon confirmation',
    description: 'A working breakfast bringing together senior leaders to discuss emerging threats, opportunities, and collaborative solutions.',
    calendarStart: '20250429T073000',
    calendarEnd: '20250429T090000',
  }
];

function getGoogleCalendarUrl(event: typeof events[0]) {
  const title = encodeURIComponent(`Spades Institute: ${event.name}`);
  const details = encodeURIComponent(`${event.description}\n\nHosted by Spades Institute at RSA Conference 2025`);
  const location = encodeURIComponent(`${event.location}`);
  return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${event.calendarStart}/${event.calendarEnd}&details=${details}&location=${location}&ctz=America/Los_Angeles`;
}

function getICSContent(event: typeof events[0]) {
  return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Spades Institute//RSA Events//EN
BEGIN:VEVENT
DTSTART;TZID=America/Los_Angeles:${event.calendarStart}
DTEND;TZID=America/Los_Angeles:${event.calendarEnd}
SUMMARY:Spades Institute: ${event.name}
DESCRIPTION:${event.description}\\n\\nHosted by Spades Institute at RSA Conference 2025
LOCATION:${event.location}
END:VEVENT
END:VCALENDAR`;
}
---

<Layout
  title="RSA Conference 2025 | Spades Institute - Design 3"
  description="Join Spades Institute at RSA Conference 2025 for exclusive dinner and breakfast events."
>
  <head slot="head">
    <link rel="canonical" href={`${siteUrl}${base}/rsa3`} />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
  </head>

  <style>
    /* ===== V3: CLASSIFIED DOSSIER - VINTAGE MILITARY INTEL ===== */
    
    .font-typewriter {
      font-family: 'Special Elite', 'Courier New', monospace;
    }
    
    .font-document {
      font-family: 'Courier Prime', 'Courier New', monospace;
    }

    /* Aged paper background */
    .paper-bg {
      background: linear-gradient(180deg, #f5f0e1 0%, #e8e0cc 50%, #f5f0e1 100%);
      position: relative;
    }

    .paper-bg::before {
      content: '';
      position: absolute;
      inset: 0;
      background: 
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 28px,
          rgba(0,0,0,0.03) 28px,
          rgba(0,0,0,0.03) 29px
        );
      pointer-events: none;
    }

    /* Paper texture overlay */
    .paper-texture {
      position: absolute;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      opacity: 0.04;
      pointer-events: none;
    }

    /* Coffee ring stain - More subtle */
    .coffee-stain {
      position: absolute;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: radial-gradient(circle at center,
        transparent 40%,
        rgba(139, 90, 43, 0.04) 45%,
        rgba(139, 90, 43, 0.06) 50%,
        rgba(139, 90, 43, 0.04) 55%,
        transparent 60%
      );
      pointer-events: none;
      opacity: 0.6;
    }

    /* TOP SECRET stamp */
    .classified-stamp {
      position: absolute;
      font-family: 'Special Elite', monospace;
      font-size: 32px;
      font-weight: bold;
      color: rgba(180, 30, 30, 0.25);
      text-transform: uppercase;
      transform: rotate(-15deg);
      letter-spacing: 0.1em;
      border: 4px solid rgba(180, 30, 30, 0.25);
      padding: 8px 24px;
      pointer-events: none;
    }

    /* Redacted text effect - Interactive */
    .redacted {
      background: #1a1a1a;
      color: #1a1a1a;
      padding: 0 4px;
      user-select: none;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .redacted:hover {
      background: transparent;
      color: #c41e3a;
    }

    .redacted::after {
      content: 'HOVER FOR DETAILS';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 8px;
      color: #c41e3a;
      opacity: 0;
      transition: opacity 0.2s;
      white-space: nowrap;
    }

    .redacted:hover::after {
      opacity: 1;
    }

    /* Official Seal */
    .official-seal {
      width: 80px;
      height: 80px;
      border: 3px solid rgba(180, 30, 30, 0.4);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Special Elite', monospace;
      font-size: 24px;
      color: rgba(180, 30, 30, 0.6);
      position: relative;
      margin: 0 auto 1rem;
    }

    .official-seal::before {
      content: '';
      position: absolute;
      inset: 4px;
      border: 2px solid rgba(180, 30, 30, 0.3);
      border-radius: 50%;
    }

    .official-seal::after {
      content: 'SPADES INSTITUTE';
      position: absolute;
      font-size: 6px;
      bottom: -8px;
      letter-spacing: 0.1em;
    }

    /* Document Number Header */
    .doc-number-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(26, 39, 68, 0.95);
      padding: 0.5rem 1rem;
      font-family: 'Courier Prime', monospace;
      font-size: 11px;
      color: #faf6eb;
      text-align: center;
      letter-spacing: 0.15em;
      z-index: 100;
      border-bottom: 2px solid #c41e3a;
    }

    /* Paper fold shadow */
    .paper-fold {
      position: relative;
    }

    .paper-fold::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, transparent 50%, rgba(0,0,0,0.05) 50%);
    }

    /* Approval stamp animation */
    .approval-stamp {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-15deg) scale(0);
      font-family: 'Special Elite', monospace;
      font-size: 48px;
      color: #22c55e;
      border: 6px solid #22c55e;
      padding: 1rem 2rem;
      background: rgba(255, 255, 255, 0.95);
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
    }

    .approval-stamp.show {
      animation: stampApproval 0.5s ease-out forwards;
    }

    @keyframes stampApproval {
      0% {
        transform: translate(-50%, -50%) rotate(-15deg) scale(2);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, -50%) rotate(-15deg) scale(1);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) rotate(-15deg) scale(1);
        opacity: 1;
      }
    }

    /* Folder tabs */
    .folder-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .folder-tab {
      padding: 0.5rem 1rem;
      background: #d4c4a8;
      border: 2px solid #b8a888;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      font-family: 'Courier Prime', monospace;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #1a2744;
      cursor: pointer;
      transition: all 0.2s;
    }

    .folder-tab:hover, .folder-tab.active {
      background: #faf6eb;
    }

    /* Document folder styling */
    .dossier-folder {
      background: #d4c4a8;
      border: 2px solid #b8a888;
      position: relative;
      box-shadow: 
        4px 4px 0 rgba(0,0,0,0.1),
        8px 8px 0 rgba(0,0,0,0.05);
    }

    .dossier-folder::before {
      content: '';
      position: absolute;
      top: -15px;
      left: 30px;
      width: 120px;
      height: 30px;
      background: #c4b498;
      border: 2px solid #b8a888;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
    }

    /* Document card */
    .document-card {
      background: #faf6eb;
      border: 1px solid #d4c8b0;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.08);
      position: relative;
    }

    .document-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: repeating-linear-gradient(
        90deg,
        #c41e3a,
        #c41e3a 20px,
        #faf6eb 20px,
        #faf6eb 40px
      );
    }

    /* Paperclip decoration */
    .paperclip {
      position: absolute;
      top: -10px;
      right: 30px;
      width: 30px;
      height: 60px;
      border: 3px solid #888;
      border-radius: 15px 15px 0 0;
      border-bottom: none;
    }

    .paperclip::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 5px;
      width: 14px;
      height: 35px;
      border: 3px solid #888;
      border-radius: 10px 10px 0 0;
      border-bottom: none;
    }

    /* Ink text styling */
    .ink-text {
      color: #1a2744;
    }

    .ink-light {
      color: #4a5568;
    }

    /* Mission badge - ink stamp style */
    .mission-stamp {
      display: inline-block;
      padding: 4px 12px;
      border: 2px solid #1a2744;
      font-family: 'Special Elite', monospace;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #1a2744;
      transform: rotate(-2deg);
    }

    /* Button styling - vintage */
    .btn-dossier {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      background: #faf6eb;
      border: 2px solid #1a2744;
      font-family: 'Courier Prime', monospace;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #1a2744;
      text-decoration: none;
      transition: all 0.2s ease;
      box-shadow: 2px 2px 0 #1a2744;
    }

    .btn-dossier:hover {
      transform: translate(-2px, -2px);
      box-shadow: 4px 4px 0 #1a2744;
    }

    .btn-dossier-primary {
      background: #1a2744;
      color: #faf6eb;
    }

    .btn-dossier-primary:hover {
      background: #2d3a56;
    }

    /* Input styling - typewriter */
    .input-dossier {
      width: 100%;
      padding: 0.75rem 1rem;
      background: #fff;
      border: 1px solid #b8a888;
      border-bottom: 2px solid #1a2744;
      font-family: 'Courier Prime', monospace;
      font-size: 14px;
      color: #1a2744;
    }

    .input-dossier:focus {
      outline: none;
      border-color: #1a2744;
      box-shadow: 0 2px 0 #1a2744;
    }

    .input-dossier::placeholder {
      color: #999;
      font-style: italic;
    }

    /* Checkbox - stamp box */
    .checkbox-dossier {
      appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid #1a2744;
      background: #fff;
      cursor: pointer;
      flex-shrink: 0;
    }

    .checkbox-dossier:checked {
      background: #1a2744;
    }

    .checkbox-dossier:checked::after {
      content: 'âœ“';
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #faf6eb;
      height: 100%;
    }

    /* Data field styling */
    .field-row {
      display: flex;
      border-bottom: 1px dashed #b8a888;
      padding: 0.5rem 0;
    }

    .field-label {
      font-family: 'Courier Prime', monospace;
      font-size: 11px;
      text-transform: uppercase;
      color: #666;
      width: 80px;
      flex-shrink: 0;
    }

    .field-value {
      font-family: 'Special Elite', monospace;
      font-size: 14px;
      color: #1a2744;
    }

    /* Section header styling */
    .section-header {
      border-bottom: 3px double #1a2744;
      padding-bottom: 0.5rem;
      margin-bottom: 1.5rem;
    }

    /* Footer - document end */
    .document-footer {
      border-top: 1px solid #b8a888;
      padding-top: 1rem;
      font-family: 'Courier Prime', monospace;
      font-size: 11px;
      color: #888;
      text-align: center;
    }

    /* Animations */
    .reveal-up {
      opacity: 0;
      transform: translateY(20px);
      animation: revealUp 0.6s ease-out forwards;
    }

    .reveal-delay-1 { animation-delay: 0.1s; }
    .reveal-delay-2 { animation-delay: 0.2s; }
    .reveal-delay-3 { animation-delay: 0.3s; }

    @keyframes revealUp {
      to { opacity: 1; transform: translateY(0); }
    }

    /* Filing mark */
    .file-mark {
      position: absolute;
      top: 20px;
      right: 20px;
      font-family: 'Courier Prime', monospace;
      font-size: 10px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    /* Hide decorations on mobile */
    @media (max-width: 768px) {
      .coffee-stain, .classified-stamp, .paperclip { display: none; }
    }
  </style>

  <!-- Document Number Header -->
  <div class="doc-number-header">
    DOCUMENT NO. SI-RSA-2025-0428 // CLASSIFICATION: RESTRICTED // SPADES INSTITUTE
  </div>

  <!-- Approval Stamp (hidden until form submit) -->
  <div class="approval-stamp" id="approvalStamp">APPROVED</div>

  <!-- Hero Section -->
  <section class="paper-bg min-h-[70vh] flex items-center justify-center relative overflow-hidden pt-12">
    <div class="paper-texture"></div>

    <!-- Decorative elements - More subtle -->
    <div class="coffee-stain" style="top: 15%; right: 20%;"></div>
    <div class="classified-stamp" style="top: 20%; left: 5%;">Top Secret</div>

    <!-- Hero Content -->
    <div class="max-w-3xl mx-auto px-6 py-20 text-center relative z-10">
      <!-- Official Seal -->
      <div class="official-seal reveal-up">â™ </div>

      <div class="mb-6 reveal-up">
        <span class="font-document text-sm uppercase tracking-[0.3em] ink-light">
          // Document Classification: <span class="text-red-700">Restricted</span> //
        </span>
      </div>

      <h1 class="font-typewriter text-4xl md:text-5xl lg:text-6xl ink-text mb-6 reveal-up reveal-delay-1">
        MISSION DOSSIER
      </h1>

      <p class="font-document text-lg ink-light mb-2 reveal-up reveal-delay-2">
        SPADES INSTITUTE â€” FIELD OPERATIONS DIVISION
      </p>

      <p class="font-document text-base ink-light max-w-xl mx-auto leading-relaxed reveal-up reveal-delay-3">
        Two invitation-only gatherings for leaders at the intersection of national security, technology, and innovation. <span class="redacted" data-reveal="75+ Leaders Attending">CLASSIFIED</span> Select your mission below.
      </p>

      <div class="mt-10 flex justify-center gap-4 flex-wrap reveal-up reveal-delay-3">
        <a href="#events" class="btn-dossier">
          â†“ Review Briefings
        </a>
        <a href="#signup" class="btn-dossier-primary">
          âœŽ Request Clearance
        </a>
      </div>
    </div>
  </section>

  <!-- Events Section -->
  <section id="events" class="paper-bg py-20 relative">
    <div class="paper-texture"></div>
    
    <div class="max-w-5xl mx-auto px-6">
      <div class="text-center mb-12 section-header">
        <p class="font-document text-xs uppercase tracking-[0.3em] ink-light mb-2">Section II</p>
        <h2 class="font-typewriter text-3xl ink-text">
          OPERATION BRIEFINGS
        </h2>
      </div>

      <div class="grid md:grid-cols-2 gap-8">
        {events.map((event, index) => (
          <div class="document-card rounded-sm p-6 relative">
            <div class="paperclip"></div>
            <div class="file-mark">File #{String(index + 1).padStart(3, '0')}</div>
            
            <div class="mb-4 mt-2">
              <span class="mission-stamp">
                Operation {String(index + 1).padStart(2, '0')}
              </span>
            </div>

            <h3 class="font-typewriter text-xl ink-text mb-1">
              {event.name}
            </h3>
            <p class="font-document text-sm ink-light italic mb-4">{event.tagline}</p>

            <div class="space-y-1 mb-4">
              <div class="field-row">
                <span class="field-label">Date:</span>
                <span class="field-value">{event.date}</span>
              </div>
              <div class="field-row">
                <span class="field-label">Time:</span>
                <span class="field-value">{event.time}</span>
              </div>
              <div class="field-row">
                <span class="field-label">Location:</span>
                <span class="field-value">{event.location}</span>
              </div>
            </div>

            <p class="font-document text-sm ink-light leading-relaxed mb-6">
              {event.description}
            </p>

            <div class="flex flex-wrap gap-3">
              <a href={getGoogleCalendarUrl(event)} target="_blank" rel="noreferrer" class="btn-dossier text-xs">
                ðŸ“… Add to Calendar
              </a>
              <button class="btn-dossier text-xs download-ics" data-event-id={event.id} data-ics-content={getICSContent(event)}>
                â¬‡ Download .ICS
              </button>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Signup Form Section -->
  <section id="signup" class="paper-bg py-20 relative">
    <div class="paper-texture"></div>
    
    <div class="max-w-xl mx-auto px-6">
      <div class="dossier-folder rounded-sm p-8 md:p-10">
        <div class="text-center mb-8">
          <p class="font-document text-xs uppercase tracking-[0.3em] ink-light mb-2">Appendix A</p>
          <h2 class="font-typewriter text-2xl ink-text">
            CLEARANCE REQUEST FORM
          </h2>
          <p class="font-document text-sm ink-light mt-3">
            Complete all fields. Venue details provided upon approval.
          </p>
        </div>

        <div id="form-success" class="hidden mb-6 p-4 bg-green-50 border-2 border-green-800">
          <p class="font-typewriter text-green-800 text-sm">âœ“ REQUEST TRANSMITTED</p>
          <p class="font-document text-green-700 text-xs mt-1">Await confirmation via secure channel.</p>
        </div>

        <div id="form-error" class="hidden mb-6 p-4 bg-red-50 border-2 border-red-800">
          <p class="font-typewriter text-red-800 text-sm" id="error-message">âœ— TRANSMISSION FAILED</p>
        </div>

        <form id="rsaSignupForm" class="space-y-5">
          <div>
            <label for="signup-name" class="block font-document text-xs uppercase tracking-wider ink-light mb-1">
              Full Name <span class="text-red-700">*</span>
            </label>
            <input id="signup-name" name="name" type="text" required placeholder="Enter your full name" class="input-dossier" />
          </div>

          <div>
            <label for="signup-company" class="block font-document text-xs uppercase tracking-wider ink-light mb-1">
              Organization <span class="text-red-700">*</span>
            </label>
            <input id="signup-company" name="company" type="text" required placeholder="Company or Agency" class="input-dossier" />
          </div>

          <div>
            <label for="signup-email" class="block font-document text-xs uppercase tracking-wider ink-light mb-1">
              Secure Email <span class="text-red-700">*</span>
            </label>
            <input id="signup-email" name="email" type="email" required placeholder="your.email@organization.com" class="input-dossier" />
          </div>

          <div>
            <label class="block font-document text-xs uppercase tracking-wider ink-light mb-3">
              Select Operation(s) <span class="text-red-700">*</span>
            </label>
            <div class="space-y-2">
              {events.map((event) => (
                <label class="flex items-start gap-3 cursor-pointer group p-2 hover:bg-white/50 transition-colors">
                  <input type="checkbox" name="events" value={event.id} class="checkbox-dossier mt-0.5" />
                  <div>
                    <span class="font-document text-sm ink-text group-hover:underline">{event.name}</span>
                    <span class="block text-xs ink-light">{event.date}</span>
                  </div>
                </label>
              ))}
            </div>
          </div>

          <div class="pt-4">
            <button type="submit" id="submit-btn" class="btn-dossier-primary w-full justify-center py-3">
              <span id="submit-text">Submit Clearance Request</span>
              <span id="submit-spinner" class="hidden">Processing...</span>
              <span id="submit-arrow">â†’</span>
            </button>
          </div>

          <p class="font-document text-xs ink-light text-center">
            All information handled per security protocols.
          </p>
        </form>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <section class="paper-bg py-12 border-t-2 border-dashed border-gray-400/50">
    <div class="max-w-4xl mx-auto px-6">
      <div class="document-footer">
        <p class="mb-4">â€” END OF DOCUMENT â€”</p>
        <p class="mb-4">
          Questions? Contact <a href="mailto:info@spadesinstitute.org" class="text-blue-800 hover:underline">info@spadesinstitute.org</a>
        </p>
        <div class="flex items-center justify-center gap-6">
          <a href={`${base}/`} class="hover:text-blue-800 hover:underline">Home</a>
          <span>|</span>
          <a href={`${base}/about/`} class="hover:text-blue-800 hover:underline">About</a>
          <span>|</span>
          <a href={`${base}/connect/`} class="hover:text-blue-800 hover:underline">Connect</a>
        </div>
        <p class="mt-6 text-[10px] tracking-widest">DOC-RSA-2025-003 // REV 1.0 // SPADES INSTITUTE</p>
      </div>
    </div>
  </section>

  <script>
    document.querySelectorAll('.download-ics').forEach(button => {
      button.addEventListener('click', () => {
        const icsContent = button.getAttribute('data-ics-content');
        const eventId = button.getAttribute('data-event-id');
        if (icsContent) {
          const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `spades-rsa-${eventId}.ics`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }
      });
    });

    const form = document.getElementById('rsaSignupForm');
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const submitSpinner = document.getElementById('submit-spinner');
    const submitArrow = document.getElementById('submit-arrow');
    const formSuccess = document.getElementById('form-success');
    const formError = document.getElementById('form-error');
    const errorMessage = document.getElementById('error-message');

    if (form) {
      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (formSuccess) formSuccess.classList.add('hidden');
        if (formError) formError.classList.add('hidden');

        const data = new FormData(form);
        const selectedEvents = data.getAll('events');
        const payload = {
          name: String(data.get('name') || ''),
          company: String(data.get('company') || ''),
          email: String(data.get('email') || ''),
          events: selectedEvents,
        };

        if (!payload.name || !payload.company || !payload.email) {
          if (formError && errorMessage) {
            errorMessage.textContent = 'âœ— Please fill in all required fields.';
            formError.classList.remove('hidden');
          }
          return;
        }

        if (selectedEvents.length === 0) {
          if (formError && errorMessage) {
            errorMessage.textContent = 'âœ— Please select at least one operation.';
            formError.classList.remove('hidden');
          }
          return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(payload.email)) {
          if (formError && errorMessage) {
            errorMessage.textContent = 'âœ— Please enter a valid email address.';
            formError.classList.remove('hidden');
          }
          return;
        }

        if (submitBtn) submitBtn.disabled = true;
        if (submitText) submitText.textContent = 'Transmitting...';
        if (submitSpinner) submitSpinner.classList.remove('hidden');
        if (submitArrow) submitArrow.classList.add('hidden');

        try {
          const eventNames = selectedEvents.map(id => {
            if (id === 'dinner') return 'Mission Brief: Dinner (April 28)';
            if (id === 'breakfast') return 'Mission Brief: Breakfast (April 29)';
            return id;
          }).join(', ');

          const formattedMessage = `RSA Conference 2025 Event Signup\n\nName: ${payload.name}\nOrganization: ${payload.company}\nEmail: ${payload.email}\nSelected Events: ${eventNames}\n\nSubmitted via RSA signup page`;

          const response = await fetch('https://api.web3forms.com/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              access_key: '217a97ca-0557-4364-86f7-66e28fbd499f',
              subject: `RSA 2025 Event Signup - ${payload.name} (${payload.company})`,
              from_name: payload.name,
              email: payload.email,
              replyto: payload.email,
              message: formattedMessage,
            }),
          });

          const result = await response.json();
          if (response.ok && result.success) {
            // Show approval stamp animation
            const approvalStamp = document.getElementById('approvalStamp');
            if (approvalStamp) {
              approvalStamp.classList.add('show');
              setTimeout(() => {
                approvalStamp.classList.remove('show');
              }, 2000);
            }
            if (formSuccess) formSuccess.classList.remove('hidden');
            form.reset();
            formSuccess?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          } else {
            if (formError && errorMessage) {
              errorMessage.textContent = result.message || 'âœ— Transmission failed. Please try again.';
              formError.classList.remove('hidden');
            }
          }
        } catch (error) {
          if (formError && errorMessage) {
            errorMessage.textContent = 'âœ— Network error. Please check your connection.';
            formError.classList.remove('hidden');
          }
        } finally {
          if (submitBtn) submitBtn.disabled = false;
          if (submitText) submitText.textContent = 'Submit Clearance Request';
          if (submitSpinner) submitSpinner.classList.add('hidden');
          if (submitArrow) submitArrow.classList.remove('hidden');
        }
      });
    }
  </script>
</Layout>
